{
    "name": "Agenda IA - Flujo Consolidado",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "agenda-ia",
                "responseMode": "responseNode",
                "options": {}
            },
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2.1,
            "position": [
                0,
                0
            ],
            "id": "node_webhook",
            "name": "Webhook"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "=Eres el Asistente de Agendamiento Inteligente de \"Agenda IA\". Tu función es procesar las solicitudes de citas que el administrador copia de la comunicación con los clientes para registrarlas en el sistema.\n\n### CONFIGURACIÓN DE CONTEXTO\n- **Sede actual**: {{ $node[\"Webhook\"].json[\"body\"][\"sede\"] || 'Sede no especificada' }}\n- **Instrucción**: Usa la sede mencionada arriba como predeterminada si el usuario no especifica una distinta.\n\n### 1. SERVICIOS PERMITIDOS\nSolo agendar: **alisado**, **repolarizacion**, **garantia** (Solo reclamos).\n\n### 2. DATOS OBLIGATORIOS\n- Cliente: Nombre, Cédula, Teléfono.\n- Cita: Servicio, Fecha, Hora, Sede.\n- Especialista: Nombre.\n\n### 3. LÓGICA DE VALIDACIÓN (Obligatoria)\nAntes de confirmar, DEBES usar la herramienta [consultar_disponibilidad_nombre].\n- Si está **bloqueado**: No agendar, avisar y pedir otro especialista.\n- Si está **ocupado**: Avisar del conflicto (menciona con quién y a qué hora) pero preguntar si se desea continuar.\n- Si está **disponible**: Confirmar y proceder.\n\n### 4. GESTIÓN DE ABONOS\nPregunta siempre por abonos (Monto, Método: 1=Efec, 2=Nequi, 3=Davi, 4=Transf, Referencia).\n\n### 5. SALIDA FINAL\nGenera el JSON final de agendamiento solo tras confirmación total.",
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 1.6,
            "position": [
                250,
                0
            ],
            "id": "node_agent",
            "name": "AI Agent"
        },
        {
            "parameters": {
                "modelName": "models/gemini-1.5-flash",
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
            "typeVersion": 1,
            "position": [
                150,
                200
            ],
            "id": "node_model",
            "name": "Google Gemini"
        },
        {
            "parameters": {
                "sessionIdType": "customKey",
                "sessionKey": "={{ $node[\"Webhook\"].json[\"body\"][\"sessionId\"] }}"
            },
            "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
            "typeVersion": 1.3,
            "position": [
                300,
                200
            ],
            "id": "node_memory",
            "name": "Memory"
        },
        {
            "parameters": {
                "name": "consultar_disponibilidad_nombre",
                "description": "Valida si un especialista puede atender. Requiere: nombre_especialista, servicio, fecha, hora_inicio.",
                "method": "POST",
                "url": "http://TU_API_URL/api/especialistas/consultar-disponibilidad-nombre",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "Authorization",
                            "value": "={{ 'Bearer ' + $node[\"Webhook\"].json[\"body\"][\"token\"] }}"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "{\n  \"nombre_especialista\": \"{{ $parameter.nombre_especialista }}\",\n  \"servicio\": \"{{ $parameter.servicio }}\",\n  \"fecha\": \"{{ $parameter.fecha }}\",\n  \"hora_inicio\": \"{{ $parameter.hora_inicio }}\"\n}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequestTool",
            "typeVersion": 4.1,
            "position": [
                450,
                150
            ],
            "id": "node_tool_disp",
            "name": "Tool: Consultar Disponibilidad"
        },
        {
            "parameters": {
                "name": "crear_cita_final",
                "description": "Registra la cita en el sistema. Úsala solo cuando el admin apruebe el resumen final.",
                "method": "POST",
                "url": "http://TU_API_URL/api/citas/agendar-externo",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "Authorization",
                            "value": "={{ 'Bearer ' + $node[\"Webhook\"].json[\"body\"][\"token\"] }}"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ $parameter.data }}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequestTool",
            "typeVersion": 4.1,
            "position": [
                450,
                250
            ],
            "id": "node_tool_create",
            "name": "Tool: Crear Cita"
        },
        {
            "parameters": {
                "options": {}
            },
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.1,
            "position": [
                650,
                0
            ],
            "id": "node_response",
            "name": "Respond to Webhook"
        }
    ],
    "connections": {
        "Webhook": {
            "main": [
                [
                    {
                        "node": "node_agent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Google Gemini": {
            "ai_languageModel": [
                [
                    {
                        "node": "node_agent",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Memory": {
            "ai_memory": [
                [
                    {
                        "node": "node_agent",
                        "type": "ai_memory",
                        "index": 0
                    }
                ]
            ]
        },
        "Tool: Consultar Disponibilidad": {
            "ai_tool": [
                [
                    {
                        "node": "node_agent",
                        "type": "ai_tool",
                        "index": 0
                    }
                ]
            ]
        },
        "Tool: Crear Cita": {
            "ai_tool": [
                [
                    {
                        "node": "node_agent",
                        "type": "ai_tool",
                        "index": 0
                    }
                ]
            ]
        },
        "node_agent": {
            "main": [
                [
                    {
                        "node": "node_response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}